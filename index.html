<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hoodie Unlocked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 25vh;
    }
    a {
      display: inline-block;
      margin-top: 20px;
      padding: 14px 24px;
      background: white;
      color: black;
      text-decoration: none;
      font-weight: bold;
      border-radius: 8px;
    }
  </style>

  <!-- üî• Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<h1>üîì Hoodie Unlocked</h1>
<p id="status">Authenticating hoodie‚Ä¶</p>
<p id="timer"></p>

<a id="lensBtn" style="display:none;" href="#">Open AR Lens</a>

<script>
/* ---------------- FIREBASE SETUP ---------------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- CONFIG ---------------- */
const LOCK_TIMEOUT = 2 * 60 * 1000; // 2 minutes

const LENS = {
  bangaloreDay: "https://www.snapchat.com/unlock/BANGALORE_DAY",
  bangaloreNight: "https://www.snapchat.com/unlock/BANGALORE_NIGHT",
  globalDay: "https://www.snapchat.com/unlock/GLOBAL_DAY",
  globalNight: "https://www.snapchat.com/unlock/GLOBAL_NIGHT"
};

const BLR_LAT = 12.9716;
const BLR_LON = 77.5946;
const ALLOWED_RADIUS_KM = 50;

/* ---------------- HELPERS ---------------- */
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

function isDayTime() {
  const h = new Date().getHours();
  return h >= 6 && h < 18;
}

/* ---------------- EXPERIENCE ---------------- */
function startExperience() {
  if (!navigator.geolocation) {
    unlock(false);
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const dist = distanceKm(
        pos.coords.latitude,
        pos.coords.longitude,
        BLR_LAT,
        BLR_LON
      );
      unlock(dist <= ALLOWED_RADIUS_KM);
    },
    () => unlock(false),
    { enableHighAccuracy: true }
  );
}

function unlock(isBangalore) {
  const day = isDayTime();
  const btn = document.getElementById("lensBtn");

  let lensURL;
  if (isBangalore) {
    lensURL = day ? LENS.bangaloreDay : LENS.bangaloreNight;
    status.innerText = "üìç Bangalore exclusive unlocked";
  } else {
    lensURL = day ? LENS.globalDay : LENS.globalNight;
    status.innerText = "üåç Global experience unlocked";
  }

  btn.href = lensURL;
  btn.style.display = "inline-block";
}

/* ---------------- LOCK LOGIC ---------------- */
async function checkAndLock() {
  const hoodieId = new URLSearchParams(window.location.search).get("hoodie");
  if (!hoodieId) return;

  const ref = db.collection("hoodies").doc(hoodieId);
  const snap = await ref.get();
  const now = Date.now();

  if (snap.exists && snap.data().inUse && now - snap.data().usedAt < LOCK_TIMEOUT) {
    document.body.innerHTML = `
      <h1>üö´ Hoodie already in use</h1>
      <p>Please try again shortly.</p>
    `;
    return;
  }

  await ref.set({ inUse: true, usedAt: now }, { merge: true });
  startTimer();
  startExperience();
}

/* ---------------- TIMER ---------------- */
function startTimer() {
  let t = 120;
  const timer = document.getElementById("timer");
  const i = setInterval(() => {
    timer.innerText = `‚è≥ Session ends in ${t--}s`;
    if (t < 0) clearInterval(i);
  }, 1000);
}

/* ---------------- AUTO RELEASE ---------------- */
window.addEventListener("beforeunload", async () => {
  const hoodieId = new URLSearchParams(window.location.search).get("hoodie");
  if (!hoodieId) return;
  await db.collection("hoodies").doc(hoodieId).set({ inUse: false }, { merge: true });
});

checkAndLock();
</script>
<script>
  alert("JS IS RUNNING");
</script>

</body>
</html>
