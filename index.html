<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hoodie Unlocked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 25vh;
    }
    a {
      display: inline-block;
      margin-top: 20px;
      padding: 14px 24px;
      background: white;
      color: black;
      text-decoration: none;
      font-weight: bold;
      border-radius: 8px;
    }
  </style>

  <!-- Firebase SDKs (COMPAT ‚Äì required) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<h1>üîì Hoodie Unlocked</h1>
<p id="status">Authenticating hoodie‚Ä¶</p>
<p id="timer"></p>

<a id="lensBtn" style="display:none;" href="#">Open AR Lens</a>

<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBn-6yjJd7C4PHF43zj-BEL_bqp4s9S5Yc",
  authDomain: "hoodie-lock.firebaseapp.com",
  projectId: "hoodie-lock",
  storageBucket: "hoodie-lock.firebasestorage.app",
  messagingSenderId: "110562874571",
  appId: "1:110562874571:web:87fa63e77cac10924c774e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= CONFIG ================= */
const LOCK_TIMEOUT = 2 * 60 * 1000; // 2 minutes

const LENS = {
  bangaloreDay: "https://www.snapchat.com/unlock/BANGALORE_DAY",
  bangaloreNight: "https://www.snapchat.com/unlock/BANGALORE_NIGHT",
  globalDay: "https://www.snapchat.com/unlock/GLOBAL_DAY",
  globalNight: "https://www.snapchat.com/unlock/?type=SNAPCODE&uuid=2b8851f84873470bbb0481e823164a9c&metadata=01"
};

const BLR_LAT = 12.9716;
const BLR_LON = 77.5946;
const ALLOWED_RADIUS_KM = 50;

/* ================= HELPERS ================= */
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

function isDayTime() {
  const h = new Date().getHours();
  return h >= 6 && h < 18;
}

/* ================= EXPERIENCE ================= */
function startExperience() {
  const statusEl = document.getElementById("status");

  if (!navigator.geolocation) {
    unlock(false);
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const dist = distanceKm(
        pos.coords.latitude,
        pos.coords.longitude,
        BLR_LAT,
        BLR_LON
      );
      unlock(dist <= ALLOWED_RADIUS_KM);
    },
    () => {
      statusEl.innerText = "üìç Location denied ‚Äî loading global experience";
      unlock(false);
    },
    { enableHighAccuracy: true }
  );
}

function unlock(isBangalore) {
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("lensBtn");
  const day = isDayTime();

  let lensURL;

  if (isBangalore) {
    lensURL = day ? LENS.bangaloreDay : LENS.bangaloreNight;
    statusEl.innerText = "üìç Bangalore exclusive experience unlocked";
  } else {
    lensURL = day ? LENS.globalDay : LENS.globalNight;
    statusEl.innerText = "üåç Global experience unlocked";
  }

  btn.href = lensURL;
  btn.style.display = "inline-block";
}

/* ================= LOCK LOGIC ================= */
async function checkAndLock() {
  const statusEl = document.getElementById("status");
  const hoodieId = new URLSearchParams(window.location.search).get("hoodie");

  if (!hoodieId) {
    statusEl.innerText = "‚ùå Invalid hoodie link";
    return;
  }

  const ref = db.collection("hoodies").doc(hoodieId);
  const snap = await ref.get();
  const now = Date.now();

  if (snap.exists) {
    const data = snap.data();
    if (data.inUse && now - data.usedAt < LOCK_TIMEOUT) {
      document.body.innerHTML = `
        <h1>üö´ Hoodie already in use</h1>
        <p>Please try again shortly.</p>
      `;
      return;
    }
  }

  await ref.set({ inUse: true, usedAt: now }, { merge: true });

  statusEl.innerText = "‚úÖ Hoodie authenticated";
  startTimer();
  startExperience();
}

/* ================= TIMER ================= */
function startTimer() {
  let t = 120;
  const timer = document.getElementById("timer");

  const i = setInterval(() => {
    timer.innerText = `‚è≥ Session ends in ${t--}s`;
    if (t < 0) clearInterval(i);
  }, 1000);
}

/* ================= AUTO RELEASE ================= */
window.addEventListener("beforeunload", async () => {
  const hoodieId = new URLSearchParams(window.location.search).get("hoodie");
  if (!hoodieId) return;
  await db.collection("hoodies").doc(hoodieId).set(
    { inUse: false },
    { merge: true }
  );
});

checkAndLock();
</script>

</body>
</html>
