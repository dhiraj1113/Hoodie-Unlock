<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hoodie Unlocked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 25vh;
    }
    a {
      display: inline-block;
      margin-top: 24px;
      padding: 14px 28px;
      background: #fff;
      color: #000;
      text-decoration: none;
      font-weight: bold;
      border-radius: 8px;
    }
    .blocked {
      color: #ff4d4d;
    }
  </style>
</head>

<body>

<h1>üîì Hoodie Unlocked</h1>
<p id="status">Verifying authenticity‚Ä¶</p>
<p><strong>Hoodie ID:</strong> <span id="hoodieId"></span></p>

<a id="lensLink" style="display:none" target="_blank">Open AR Lens</a>

<script>
  const params = new URLSearchParams(window.location.search);
  const hoodie = params.get("hoodie");
  const ts = params.get("ts");

  document.getElementById("hoodieId").innerText = hoodie || "Not Assigned";

  /* ======================
     1Ô∏è‚É£ TIME EXPIRY CHECK
     ====================== */
  const now = Date.now();
  const expiryWindow = 5 * 60 * 1000; // 5 minutes

  if (!ts || now - ts > expiryWindow) {
    document.getElementById("status").innerHTML =
      "<span class='blocked'>‚õî Link expired. Tap hoodie again.</span>";
    throw new Error("Expired link");
  }

  /* ======================
     2Ô∏è‚É£ DEVICE LOCK
     ====================== */
  const deviceKey = "used_" + hoodie;

  if (localStorage.getItem(deviceKey)) {
    document.getElementById("status").innerHTML =
      "<span class='blocked'>‚ö†Ô∏è Already unlocked on this device.</span>";
    throw new Error("Device already used");
  }

  localStorage.setItem(deviceKey, "true");

  /* ======================
     3Ô∏è‚É£ LOCATION LOCK
     ====================== */
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // Bangalore geo-fence
      const isBangalore = lat > 12 && lat < 14 && lon > 77 && lon < 78;

      if (!isBangalore) {
        document.getElementById("status").innerHTML =
          "<span class='blocked'>üìç Location restricted.</span>";
        return;
      }

      /* ======================
         4Ô∏è‚É£ DYNAMIC LENS LOGIC
         ====================== */
      const hour = new Date().getHours();
      const isNight = hour >= 18 || hour < 6;

      let lensURL = "";

      if (isNight) {
        lensURL = "https://www.snapchat.com/unlock/?uuid=NIGHT_LENS_UUID";
        document.getElementById("status").innerText =
          "üåô Night experience unlocked";
      } else {
        lensURL = "https://www.snapchat.com/unlock/?uuid=DAY_LENS_UUID";
        document.getElementById("status").innerText =
          "‚òÄÔ∏è Day experience unlocked";
      }

      const lensBtn = document.getElementById("lensLink");
      lensBtn.href = lensURL;
      lensBtn.style.display = "inline-block";
    },
    () => {
      document.getElementById("status").innerHTML =
        "<span class='blocked'>üìç Location permission required.</span>";
    }
  );
</script>

</body>
</html>


