<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hoodie Unlocked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 25vh;
    }
    a {
      display: inline-block;
      margin-top: 20px;
      padding: 14px 24px;
      background: white;
      color: black;
      text-decoration: none;
      font-weight: bold;
      border-radius: 8px;
    }
  </style>
</head>

<body>

<h1>ðŸ”“ Hoodie Unlocked</h1>
<p id="status">Checking hoodie location...</p>

<a id="lensBtn" style="display:none;" href="#">Open AR Lens</a>

<script>
  // ðŸ”¹ CHANGE THESE TO YOUR REAL SNAP LENS LINKS
  const LENS = {
    bangaloreDay: "https://www.snapchat.com/unlock/BANGALORE_DAY",
    bangaloreNight: "https://www.snapchat.com/unlock/BANGALORE_NIGHT",
    globalDay: "https://www.snapchat.com/unlock/GLOBAL_DAY",
    globalNight: "https://www.snapchat.com/unlock/GLOBAL_NIGHT"
  };

  // Bangalore coordinates
  const BLR_LAT = 12.9716;
  const BLR_LON = 77.5946;
  const ALLOWED_RADIUS_KM = 50; // Bangalore + nearby areas

  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  function isDayTime() {
    const hour = new Date().getHours();
    return hour >= 6 && hour < 18;
  }

  function unlockLens(isBangalore) {
    const day = isDayTime();
    let lensURL;

    if (isBangalore) {
      lensURL = day ? LENS.bangaloreDay : LENS.bangaloreNight;
      document.getElementById("status").innerText =
        "ðŸ“ Bangalore detected â€” Exclusive experience unlocked";
    } else {
      lensURL = day ? LENS.globalDay : LENS.globalNight;
      document.getElementById("status").innerText =
        "ðŸŒ Global experience unlocked";
    }

    const btn = document.getElementById("lensBtn");
    btn.href = lensURL;
    btn.style.display = "inline-block";
  }

  if (!navigator.geolocation) {
    document.getElementById("status").innerText =
      "Location not supported. Loading global experience.";
    unlockLens(false);
  } else {
    navigator.geolocation.getCurrentPosition(
      position => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        const dist = distanceKm(userLat, userLon, BLR_LAT, BLR_LON);
        unlockLens(dist <= ALLOWED_RADIUS_KM);
      },
      error => {
        document.getElementById("status").innerText =
          "Location denied. Loading global experience.";
        unlockLens(false);
      },
      { enableHighAccuracy: true }
    );
  }
</script>
<script>
  const LOCK_TIMEOUT = 2 * 60 * 1000; // 2 minutes

  async function checkAndLock() {
    const hoodieId = new URLSearchParams(window.location.search).get("hoodie");
    if (!hoodieId) return;

    const ref = db.collection("hoodies").doc(hoodieId);
    const snap = await ref.get();
    const now = Date.now();

    if (snap.exists) {
      const data = snap.data();

      if (data.inUse && now - data.usedAt < LOCK_TIMEOUT) {
        document.body.innerHTML = `
          <h1>ðŸš« Hoodie already in use</h1>
          <p>Please tap the hoodie again after a moment.</p>
        `;
        return;
      }
    }

    await ref.set({
      inUse: true,
      usedAt: now
    }, { merge: true });

    // ðŸ‘‰ continue to lens / experience after this
    startExperience();
  }

  checkAndLock();
</script>

</body>
</html>
